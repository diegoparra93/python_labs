import json
from typing import List
from .models import Student

def students_to_json(students: List[Student], path: str) -> None:
    """
    Save list of students to JSON file.
    VERSION WITH CHECKS (like your friend's)
    """
    # 1. Check that students is a list
    if not isinstance(students, list):
        raise TypeError(f"students must be a list, not {type(students)}")
    
    # 2. Check all elements are Student objects
    for i, student in enumerate(students):
        if not isinstance(student, Student):
            raise TypeError(f"Element {i} is not a Student object")
    
    # 3. Convert to dictionaries
    students_data = []
    for student in students:
        # to_dict() will check fields are not empty
        students_data.append(student.to_dict())
    
    # 4. Save to file
    try:
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(students_data, f, ensure_ascii=False, indent=2)
        print(f"âœ… JSON file saved: {path}")
    except Exception as e:
        raise IOError(f"Error saving file {path}: {e}")

def students_from_json(path: str) -> List[Student]:
    """
    Load list of students from JSON file.
    VERSION WITH CHECKS (like your friend's)
    """
    # 1. Read file
    try:
        with open(path, 'r', encoding='utf-8') as f:
            data = json.load(f)
    except FileNotFoundError:
        raise FileNotFoundError(f"File not found: {path}")
    except json.JSONDecodeError as e:
        raise ValueError(f"Error in JSON file {path}: {e}")
    
    # 2. Check that data is a list
    if not isinstance(data, list):
        raise ValueError(f"JSON must contain a list, not {type(data)}")
    
    # 3. Create students
    students = []
    errors = []
    
    for i, item in enumerate(data):
        try:
            # Check required fields in dictionary
            required = ["full_name", "birthdate", "group", "gpa"]
            for field in required:
                if field not in item:
                    raise ValueError(f"Missing field '{field}'")
            
            # Create student (validation will happen in __post_init__)
            student = Student.from_dict(item)
            students.append(student)
            
        except Exception as e:
            errors.append(f"Row {i}: {e}")
    
    # 4. If there are errors - show them
    if errors:
        error_msg = "\n".join(errors)
        raise ValueError(f"Errors loading students:\n{error_msg}")
    
    return students